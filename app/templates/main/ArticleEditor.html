<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title></title>
    <link rel="stylesheet" href="{{ url_for('main.static',filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('main.static',filename='font-awesome-4.7.0/css/font-awesome.min.css') }}">

    <script src="{{ url_for('main.static',filename='ckeditor/ckeditor.js') }}"></script>
    <script src="{{ url_for('main.static',filename='jquery.min.js') }}"></script>
    <script src="{{ url_for('main.static',filename='bootstrap.min.js') }}"></script>
    <script src="{{ url_for('main.static',filename='get_token.js') }}"></script>

    <style>
        #article_table > tbody > tr > td:first-child {text-align: center;vertical-align: middle!important;}
        .fa-trash-o:hover {box-shadow: 1px 1px 1px 1px;}
        .fa-pencil:hover {box-shadow: 1px 1px 1px 1px;}
        #page {margin-top:70px;}
        .second-menu > li {padding-left: 5%;}
        .nav-header > a > .fa-angle-down {float:right;}
        .fa-angle-down {padding: 5px 5px}
    </style>
</head>
<body>
<!-- -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <!-- toggle for responsive screen -->
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" aria-controls="navbar" aria-expanded="false" data-target="#fullmoon-navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="" class="navbar-brand">Admin Panel</a><!-- logo for navibar -->
        </div><!--navbar header-->

        <!-- navbar links -->
        <div class="collapse navbar-collapse navbar-responsive-collapse" id="fullmoon-navbar">
            <form action="" class="navbar-form navbar-right">
                <a href="#" class="btn dropdown-toggle" id="self" data-toggle="dropdown"><i class="fa fa-user-circle-o"></i>&nbsp;{{ current_user.user }}<span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="self">
                    <li role="presentation" tabindex="-1"><a href="#"><i class="fa fa-file-text"></i>&nbsp;Profile</a></li>
                    <li role="presentation" tabindex="-1"><a href="?logout=True"><i class="fa fa-power-off"></i>&nbsp;Log out</a></li>
                </ul>
            </form>
        </div><!-- navbar-collapse -->
    </div><!--container-fluid-->
</nav>

<div class="container-fluid" id="page">
    <div class="row">
        <div class="col-md-2">
            <div id="sidebar" class="panel panel-default">
                <div class="panel-heading"><a href="#" data-toggle="collapse"><i class="fa fa-angle-double-left"></i></a></div>
                <ul class="nav nav-list">
                    <li><a href="#"><i class="fa fa-dashboard"></i>&nbsp;仪表盘</a></li>
                    <li class="nav-header"><a href="#manage_article" data-toggle="collapse"><i class="fa fa-book"></i>&nbsp;图书馆<i class="fa fa-angle-down"></i></a></li>
                        <ul id="manage_article" class="nav nav-list collapse second-menu">
                            <li role="presentation"><a href="#new-article" data-toggle="tab"><i class="fa fa-plus-circle"></i>&nbsp;新增文章</a></li>
                            <li role="presentation"><a href="#manage-article" data-toggle="tab"><i class="fa fa-gear"></i>&nbsp;管理文章</a></li>
                            <li role="presentation"><a href="#" data-toggle="tab"><i class="fa fa-comments-o"></i>&nbsp;评论管理</a></li>
                        </ul>
                    <li class="nav-header"><a href="#manage_system" data-toggle="collapse"><i class="fa fa-th"></i>&nbsp;其他<i class="fa fa-angle-down"></i></a></li>
                        <ul id="manage_system" class="nav nav-list collapse second-menu">
                            <li role="presentation"><a href="#">功能1</a></li>
                            <li role="presentation"><a href="#">功能2</a></li>
                        </ul>
                </ul>
            </div>
        </div>
        <div class="col-md-10">
            <div class="tab-content">
                <div class="modal fade" id="check_to_delete" tabindex="-1" role="dialog" aria-labelledby="modallabel" aria-hidden="true">
                        <div class="modal-dialog modal-sm"><!--small modal-->
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                        &times;
                                    </button>
                                    <h4 class="modal-title" id="myModalLabel">
                                        <span style="color:red;"><i class="fa fa-exclamation-triangle"></i>警告</span>
                                    </h4>
                                </div>
                                <div class="modal-body">
                                    <p>您正在尝试删除文章，该操作不可逆，确定吗？</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-warning" data-dismiss="modal" onclick="return false">关闭
                                    </button>
                                    <button type="button" class="btn btn-primary" id="confirm_to_delete">
                                        确认
                                    </button>
                                </div>
                            </div><!-- /.modal-content -->
                        </div><!-- /.modal -->
                    </div>

                <!--manage articels in database-->
                <div class="panel panel-info tab-pane" id="manage-article">
                    <div class="panel-heading">ManageBoard<a href="#"><i class="fa fa-refresh" style="float: right;display: block;vertical-align: middle;padding: 5px 5px;" id="manageboard-refresh"></i></a></div>
                    <div class="panel-body">
                        <div>
                            <select name="" id="">
                                <option value="">--Category--</option>
                                <option value="">1</option>
                                <option value="">2</option>
                                <option value="">3</option>
                            </select>
                            <div id="manage_table">
                                <div class="table">
                            <table class="table table-striped table-condensed">
                            <tr>
                                <td>标题</td>
                                <td>标签</td>
                                <td>正文</td>
                                <td>创建日期</td>
                                <td>状态</td>
                                <td colspan="2">操作</td>
                            </tr>
                                {% for article in article_for_administration %}
                                    <tr>
                                    <td class="uuid" style="display: none;">{{ article.uuid }}</td>
                                    <td>{{ article.title }}</td>
                                    <td>{{ article.tags }}</td>
                                    <td>{{ article.content[:40]|sanitize_html }}</td>
                                    <td>{{ article.create_date.strftime("%Y-%m-%d %H:%M") }}</td>
                                    <td>
                                        <label for="">
                                            <select name="" class="select_of_status">
                                                <option value="{{ article.status }}">{{ article.status }}</option>
                                            </select>
                                        </label>
                                    </td>
                                    <td><a href="/{{ article.author }}/blog/article/{{ article.uuid }}?edit=true" data-toggle="tooltip" title="修改文章" target="_blank"><i class="fa fa-pencil" style="color: blue"></i></a></td>
                                    <td><a href="#" data-toggle="tooltip" title="删除文章"><i class="fa fa-trash-o" style="color: red"></i></a></td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--ckeditor-->
                <div class="tab-pane panel panel-info" id="new-article">
                    <div class="panel-heading">CKEditor</div>
                    <div class="panel-body">
                        <div>
                            <!--flashed messages write here when ajax received status-->
                            <div class="alert alert-info" style="display: none;" id="message_add">
                                <strong>新增成功!</strong> 文章已被添加至数据库，再次提交可以进行修改。注意文章发布状态！
                            </div>
                            <div class="alert alert-success" style="display: none;" id="message_update">
                                <strong>更新成功!</strong> 文章已经被更新到数据库，再次保存继续更新文章。注意文章发布状态！
                            </div>
                            <div class="alert alert-warning" style="display: none;" id="message_failed">
                                <strong>操作失败!</strong> 原因是输入了不被允许的字段值，请检查输入是否有误。
                            </div>
                            <!--form-->
                            <form action="" method="post" id="article_form">
                                <input type="hidden" name="_crsf_token" id="_crsf_token" value="{{ crsf_token() }}">
                                <input type="hidden" name="_uuid" id="_uuid" value="{{ uuid() }}"><!--insert uuid here,updated only when the page refreshed-->
                                <div class="table">
                                    <table class="table table-condensed table-bordered" id="article_table">
                                        <div class="row">
                                        <tr>
                                            <td>文章标题</td>
                                            <td><input type="text" name="title" required="required" id="article_title"></td>
                                        </tr>
                                        <tr>
                                            <td>文章分类</td>
                                            <td>
                                                <select name="category" id="article_category">
                                                    <option value="">--分类--</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>文章状态</td>
                                            <td>
                                                <select name="status" id="article_status">
                                                    <option value="DRAFTED">草稿</option>
                                                    <option value="PUBLISHED">发布</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2">
                                                <textarea id="article_content" cols="20" rows="2" class="ckeditor" name="content"></textarea>
                                            </td>
                                        </tr>
                                        </div>
                                    </table>
                                </div>
                        </form>
                        </div>
                    </div>
                </div>
            </div><!--tab content-->
        </div>
    </div>
</div>

<script>
    var $SCRIPT_ROOT = "{{ request.script_root|safe }}";
    var $AUTHOR = "{{ current_user.user }}";
    $(document).ready(function () {
        //data-toggle tooltip
        $("[data-toggle='tooltip']").tooltip();
        //use ajax not to refresh the page
        var editor = CKEDITOR.instances['article_content'];
        editor.on('instanceReady',function (event) {
            //when add a new article, clear all data of form
            editor.addCommand('save',{
                exec:function () {
                    var flag = 'add_article';//flag indicator to distinguish different POST requests
                    var uuid = $("#_uuid").val();
                    var crsf_token = $("#_crsf_token").val();
                    var article_title = $("#article_title").val();
                    var article_category = $("#article_category").val();
                    var article_status = $("#article_status").val();
                    var article_content = editor.getData();//get html source code of editor,through the id
                    var article_edit_date = new Date().toISOString();//UTC +00
                    //CKEDITOR.instances['article_content'].setData() set Data to CKEDITOR
                    //console.log(article_title,article_category,article_status,article_content);
                    $.ajax({
                        beforeSend:function (request) {request.setRequestHeader("Authorization", BasicAuthorizationCode(get_token(),"unused"));},
                        url:$SCRIPT_ROOT + '/api/article/uuid/' + uuid,
                        type:'PUT',
                        data:{
                            "_method":"PUT",
                            "edit_date":article_edit_date,
                            "uuid":uuid,
                            "author":$AUTHOR,//have bug here
                            "_crsf_token":crsf_token,
                            "title":article_title,
                            "category":article_category,
                            "status":article_status,
                            "content":article_content
                        },
                        dataType:'json',
                        success:function (res) {
                            if(res['message'] == "update success") {
                                $("#message_update").show().delay(3000).fadeOut();
                            }
                            if(res['message'] == "add success") {
                                $("#message_add").show().delay(3000).fadeOut();
                            }
                        },//success
                        error:function (res) {
                            $("#message_failed").show().delay(4000).fadeOut();
                        }//error
                    });//ajax here
                }//exec function
            });//editor.addCommand() function
            //new page logical here
            editor.addCommand('newpage',{
                exec:function () {
                    //reset the form
                    $("#article_form")[0].reset();
                    //update uuid
                    $.ajax({
                        beforeSend:function (request) {request.setRequestHeader("Authorization", BasicAuthorizationCode(get_token(),"unused"));},
                        url:$SCRIPT_ROOT + 'api/tools/uuid/',
                        type:'POST',
                        dataType:'json',
                        success:function (res) {
                            //console.log(res['uuid']);
                            $("#_uuid").attr('value',res['uuid']);
                        },//success
                        error:function (res) {}//error
                    });//ajax here
                    editor.setData();
                }//exec
            });//editor.addCommand
        });//editor.on() function
        //when click the trash icon
        $("i.fa.fa-trash-o").click(modal_delete);
        //when confirm to delete the article, show modal
        $("#confirm_to_delete").click(function () {
            var uuid = $(this).parents().siblings(".modal-body").children("p").attr("id");
            console.log(uuid);
            $.ajax({
                beforeSend:function (request) {request.setRequestHeader("Authorization", BasicAuthorizationCode(get_token(),"unused"));},
                type:'delete',
                url:$SCRIPT_ROOT + 'api/article/uuid/' + uuid,
                data:{"_method":"DELETE"},
                dataType:"json",
                success:function () {
                    console.log('success');
                    $("#check_to_delete").modal("hide");
                }
           });
        });
        //ajax load <option></option> from database
        //when change options in select tags, do the same to database
        $(".select_of_status").on({
            click: select_click,
            change: select_select
        });
        //ajax refresh the page after do changes with article
        $("#manageboard-refresh").click(function () {
            var self = $(this);
            $.ajax({
                beforeSend: function(){self.addClass("fa-spin");},// Use the fa-spin class to get any icon to rotate
                url: "{{ url_for('main.main_temp_1') }}",
                dataType:"html",
                type: "GET",
                success: function (data) {
                    $("#manage_table").html(data);
                    //re-register function to event handler
                    $("[data-toggle='tooltip']").tooltip();
                    $("i.fa.fa-trash-o").click(modal_delete);
                    $(".select_of_status").on({
                        click: select_click,
                        change: select_select
                    });
                },
                complete:function(){self.removeClass("fa-spin");}// stop rotate
            })
        })
    })
</script>
</body>
</html>
